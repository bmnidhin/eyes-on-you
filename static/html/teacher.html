<html>

<head>
   
</head>

<body>
        <div class="mx-auto row justify-content-md-center" style="height: 35%;">


                <div class="mx-auto row form-group">
                    <div class="col text-center" style="width: 30%;">
                        <label for="room" class="col-form-label">Room Number</label>
                    </div>

                    <div class="col" style="width: 70%;">

                        <input type="number" class="form-control" id="roomnum"></input>
                    </div>
                </div>
                <div class="mx-auto form-group row">
                    <div class="col text-center">
                        <div class="generateroom center btn btn-outline-primary">Start</div>
                    </div>
                </div>

            </div>
        </div>
        <div class="col"></div>
    <div class="mx-auto row justify-content-md-center" style="height: 15%;">&nbsp;</div>
    <div class="mx-auto row" id="videos" style="height:50%">

    </div>

    <!-- scripts! -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <!-- JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script>
        var videos = document.getElementById("videos")
        var students = [student()];

        function student() {
            var a = {}
            a.connection = new RTCPeerConnection({
                iceServers: [{
                    urls: "stun:stun.1.google.com:19302"
                }]
            })
            a.connection.onaddstream = function(student) {
                console.log(student)
                var video = document.createElement("video");
                video.srcObject = student.stream;
                video.play();
                video.classList.add('stream');
                video.classList.add('video');
                video.classList.add('webcam');
                video.setAttribute("id", students.length);
                video.onclick = function(event) {
                    event.target.classList.add('screenShare');
                    event.target.classList.remove('webcam');
                }
                videos.appendChild(video);
            }

            a.lastImg;

            return a;
        }
        var room;
        students[0] = student();
        $(".generateroom").click(function() {
            $(".dataenter").toggle();
            $("#videos").toggle();
            setTimeout(startref, 1000);
            room = $("#roomnum").val();
            createRoom(students[0].connection);

        })

        function createRoom(sconnection) {


            sconnection.createOffer({
                offerToReceiveVideo: true,
                offerToReceiveAudio: true
            }).then(function(hostdesc) {
                sconnection.setLocalDescription(hostdesc)
            })
            sconnection.onicecandidate = function() {

                $.post("/createroom", {
                    room: room,
                    key: sconnection.localDescription.sdp
                }, function(data) {

                })
            }
        }


        student[0] = student();

        function startref() {
            setInterval(function() {
                $.post("/reload", {
                    room: room,
                }, function(users) {
                    if (users) {
                        users.forEach(
                            function(user) {
                                students[students.length - 1].connection.setRemoteDescription(new RTCSessionDescription({
                                    type: "answer",
                                    sdp: user
                                }));
                                var newStudent = student();
                                students.push(newStudent);
                                createRoom(newStudent.connection);
                            });
                    }
                });
            }, 1000)

        }
    </script>
</body>




</html>